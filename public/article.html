<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Article | ImSexpat</title>
    <meta name="description" content="" />
    <meta property="og:title" content="" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="brand">ImSexpat</div>
      <nav class="site-nav" aria-label="Navigation principale">
        <a class="nav-link" href="/">Accueil</a>
        <a class="nav-link" href="/articles">Articles</a>
        <div class="nav-dropdown" id="categoriesDropdown">
          <button
            id="categoriesToggle"
            class="dropdown-toggle"
            type="button"
            aria-haspopup="true"
            aria-expanded="false"
          >
            Categories
          </button>
          <div id="categoriesMenu" class="dropdown-menu" hidden>
            <a class="dropdown-item" href="/articles">Toutes categories</a>
          </div>
        </div>
      </nav>
      <a class="admin-link" href="/admin/login">Admin</a>
    </header>

    <main>
      <article class="admin-panel admin-panel-wide article-view">
        <h1 id="title">Chargement...</h1>
        <p id="meta" class="article-meta" hidden></p>
        <p id="excerpt" class="article-excerpt"></p>
        <img id="cover" class="cover-image" alt="" hidden />
        <div id="content" class="article-content"></div>
      </article>
    </main>

    <script>
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      const slug = pathParts[pathParts.length - 1] || '';

      const titleEl = document.getElementById('title');
      const metaEl = document.getElementById('meta');
      const excerptEl = document.getElementById('excerpt');
      const contentEl = document.getElementById('content');
      const coverEl = document.getElementById('cover');
      const categoriesToggleEl = document.getElementById('categoriesToggle');
      const categoriesMenuEl = document.getElementById('categoriesMenu');
      const categoriesDropdownEl = document.getElementById('categoriesDropdown');
      const escapeHtml = (value) => String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
      const closeCategoriesMenu = () => {
        if (!categoriesMenuEl || !categoriesToggleEl) return;
        categoriesMenuEl.hidden = true;
        categoriesToggleEl.setAttribute('aria-expanded', 'false');
      };

      const openCategoriesMenu = () => {
        if (!categoriesMenuEl || !categoriesToggleEl) return;
        categoriesMenuEl.hidden = false;
        categoriesToggleEl.setAttribute('aria-expanded', 'true');
      };

      const renderCategoryMenu = (categories) => {
        if (!categoriesMenuEl) return;
        const list = Array.isArray(categories) ? categories.filter(Boolean) : [];
        categoriesMenuEl.innerHTML = `
          <a class="dropdown-item" href="/articles">Toutes categories</a>
          ${list.map((category) => `
            <a class="dropdown-item" href="/articles?category=${encodeURIComponent(category)}">${escapeHtml(category)}</a>
          `).join('')}
        `;
      };

      const renderMetaLine = (article) => {
        const categories = Array.isArray(article.categories) ? article.categories.filter(Boolean) : [];
        const tags = Array.isArray(article.tags) ? article.tags.filter(Boolean) : [];
        const groups = [];

        if (categories.length) {
          groups.push(`
            <span class="meta-group">
              <strong>Categories:</strong>
              ${categories.map((x) => `<span class="chip">${escapeHtml(x)}</span>`).join('')}
            </span>
          `);
        }
        if (tags.length) {
          groups.push(`
            <span class="meta-group">
              <strong>Tags:</strong>
              ${tags.map((x) => `<span class="chip">${escapeHtml(x)}</span>`).join('')}
            </span>
          `);
        }

        if (!groups.length) {
          metaEl.hidden = true;
          metaEl.innerHTML = '';
          return;
        }

        metaEl.hidden = false;
        metaEl.innerHTML = groups.join('');
      };

      const setMeta = (selector, value) => {
        const el = document.querySelector(selector);
        if (el) {
          el.setAttribute('content', value || '');
        }
      };

      fetch('/api/articles?page=1&pageSize=1', { cache: 'no-store' })
        .then((res) => (res.ok ? res.json() : null))
        .then((payload) => {
          const categories = payload && payload.taxonomies ? payload.taxonomies.categories || [] : [];
          renderCategoryMenu(categories);
        })
        .catch(() => {
          renderCategoryMenu([]);
        });

      fetch(`/api/articles/${encodeURIComponent(slug)}`, { cache: 'no-store' })
        .then((res) => {
          if (!res.ok) throw new Error('Article introuvable');
          return res.json();
        })
        .then((article) => {
          titleEl.textContent = article.title;
          renderMetaLine(article);
          excerptEl.textContent = article.excerpt || '';
          document.title = article.seoTitle || article.title || 'Article | ImSexpat';
          setMeta('meta[name=\"description\"]', article.seoDescription || article.excerpt || '');
          setMeta('meta[property=\"og:title\"]', article.seoTitle || article.title || '');
          setMeta('meta[property=\"og:description\"]', article.seoDescription || article.excerpt || '');
          setMeta('meta[property=\"og:image\"]', article.ogImageUrl || article.coverImageUrl || '');

          if (article.coverImageUrl) {
            coverEl.src = article.coverImageUrl;
            coverEl.alt = article.title;
            coverEl.hidden = false;
          }

          contentEl.innerHTML = article.content || '<p>Contenu vide.</p>';
        })
        .catch(() => {
          titleEl.textContent = 'Article introuvable';
          metaEl.hidden = true;
          metaEl.innerHTML = '';
          excerptEl.textContent = '';
          contentEl.innerHTML = '<p>Ce contenu nest pas disponible.</p>';
        });

      if (categoriesToggleEl && categoriesDropdownEl) {
        categoriesToggleEl.addEventListener('click', (event) => {
          event.preventDefault();
          const expanded = categoriesToggleEl.getAttribute('aria-expanded') === 'true';
          if (expanded) {
            closeCategoriesMenu();
            return;
          }
          openCategoriesMenu();
        });

        document.addEventListener('click', (event) => {
          if (!categoriesDropdownEl.contains(event.target)) {
            closeCategoriesMenu();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') closeCategoriesMenu();
        });

        categoriesMenuEl.addEventListener('click', () => {
          closeCategoriesMenu();
        });
      }
    </script>
  </body>
</html>
