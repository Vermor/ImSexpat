<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ImSexpat</title>
    <meta name="description" content="ImSexpat" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="brand" id="brand">ImSexpat</div>
      <a class="admin-link" href="/admin/login">Admin</a>
    </header>

    <main>
      <section class="hero">
        <h1 id="heroTitle">Journal d'un sexpat</h1>
        <p class="subtitle" id="heroSubtitle">recit, informations, news sur la vie d'un sexpat</p>
        <div class="hero-actions">
          <a id="heroCta" href="/articles" class="btn btn-ghost">Voir les themes</a>
        </div>
      </section>

      <section id="articles" class="grid">
        <article class="card">
          <h2 id="card1Title">Installation expat</h2>
          <p id="card1Text">Checklist arrivee, visa, assurance, banque et appart a Bangkok ou Chiang Mai.</p>
        </article>
        <article class="card">
          <h2 id="card2Title">Vie quotidienne</h2>
          <p id="card2Text">Transports, sante, courses, quartiers et habitudes culturelles a connaitre.</p>
        </article>
        <article class="card">
          <h2 id="card3Title">Week-ends & iles</h2>
          <p id="card3Text">Itineraires realistes depuis les grandes villes vers les meilleures escapades.</p>
        </article>
      </section>

      <section class="admin-panel article-list-panel">
        <h2>Derniers articles</h2>
        <div id="latestArticles" class="admin-list">
          <p class="muted">Chargement...</p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <p>© <span id="year"></span> <span id="footerText">ImSexpat</span></p>
    </footer>

    <script>
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el && typeof value === 'string') {
          el.textContent = value;
        }
      };

      const setMetaDescription = (value) => {
        const meta = document.querySelector('meta[name="description"]');
        if (meta && value) {
          meta.setAttribute('content', value);
        }
      };

      const applyLandingContent = (content) => {
        if (!content || typeof content !== 'object') return;

        if (content.pageTitle) {
          document.title = content.pageTitle;
        }

        setMetaDescription(content.metaDescription);
        setText('brand', content.siteName);
        setText('heroTitle', content.heroTitle);
        setText('heroSubtitle', content.heroSubtitle);
        setText('card1Title', content.card1Title);
        setText('card1Text', content.card1Text);
        setText('card2Title', content.card2Title);
        setText('card2Text', content.card2Text);
        setText('card3Title', content.card3Title);
        setText('card3Text', content.card3Text);
        setText('footerText', content.footerText || content.siteName);

        const cta = document.getElementById('heroCta');
        if (cta && content.ctaText) {
          cta.textContent = content.ctaText;
          cta.href = content.ctaHref || '/articles';
        }
      };

      const loadLandingContent = async () => {
        try {
          const response = await fetch('/api/landing', { cache: 'no-store' });
          if (!response.ok) return;
          const content = await response.json();
          applyLandingContent(content);
        } catch (error) {
          console.error('Landing content load failed:', error);
        }
      };

      const escapeHtml = (value) => String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');

      const renderLatestArticles = (articles) => {
        const listEl = document.getElementById('latestArticles');
        if (!listEl) return;

        if (!Array.isArray(articles) || articles.length === 0) {
          listEl.innerHTML = '<p class="muted">Aucun article publie pour le moment.</p>';
          return;
        }

        const top = articles.slice(0, 6);
        listEl.innerHTML = top.map((article) => `
          <article class="list-item vertical-item">
            <h3><a href="/article/${encodeURIComponent(article.slug)}">${escapeHtml(article.title)}</a></h3>
            <p class="muted">${escapeHtml(article.excerpt || '')}</p>
          </article>
        `).join('');
      };

      const loadLatestArticles = async () => {
        try {
          const response = await fetch('/api/articles', { cache: 'no-store' });
          if (!response.ok) throw new Error('Failed to load articles');
          const articles = await response.json();
          renderLatestArticles(articles);
        } catch (error) {
          const listEl = document.getElementById('latestArticles');
          if (listEl) {
            listEl.innerHTML = '<p class="error">Erreur de chargement des articles.</p>';
          }
          console.error(error);
        }
      };

      document.getElementById('year').textContent = new Date().getFullYear();
      loadLandingContent();
      loadLatestArticles();
    </script>
  </body>
</html>
