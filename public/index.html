<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ImSexpat</title>
    <meta name="description" content="ImSexpat" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="brand" id="brand">ImSexpat</div>
      <a class="admin-link" href="/admin/login">Admin</a>
    </header>

    <main>
      <section class="hero">
        <h1 id="heroTitle">Journal d'un sexpat</h1>
        <p class="subtitle" id="heroSubtitle">recit, informations, news sur la vie d'un sexpat</p>
      </section>

      <section class="admin-panel article-list-panel latest-article-section">
        <h2>Dernier article publie</h2>
        <div id="latestArticle">
          <p class="muted">Chargement...</p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <p>© <span id="year"></span> <span id="footerText">ImSexpat</span></p>
    </footer>

    <script>
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el && typeof value === 'string') {
          el.textContent = value;
        }
      };

      const setMetaDescription = (value) => {
        const meta = document.querySelector('meta[name="description"]');
        if (meta && value) {
          meta.setAttribute('content', value);
        }
      };

      const applyLandingContent = (content) => {
        if (!content || typeof content !== 'object') return;

        if (content.pageTitle) {
          document.title = content.pageTitle;
        }

        setMetaDescription(content.metaDescription);
        setText('brand', content.siteName);
        setText('heroTitle', content.heroTitle);
        setText('heroSubtitle', content.heroSubtitle);
        setText('footerText', content.footerText || content.siteName);
      };

      const loadLandingContent = async () => {
        try {
          const response = await fetch('/api/landing', { cache: 'no-store' });
          if (!response.ok) return;
          const content = await response.json();
          applyLandingContent(content);
        } catch (error) {
          console.error('Landing content load failed:', error);
        }
      };

      const escapeHtml = (value) => String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');

      const renderChips = (items, label) => {
        if (!Array.isArray(items) || items.length === 0) return '';
        return `
          <p class="muted">${label}: ${items.map((x) => `<span class="chip">${escapeHtml(x)}</span>`).join(' ')}</p>
        `;
      };

      const renderLatestArticle = (article) => {
        const container = document.getElementById('latestArticle');
        if (!container) return;

        if (!article) {
          container.innerHTML = '<p class="muted">Aucun article publie pour le moment.</p>';
          return;
        }

        container.innerHTML = `
          <article class="list-item vertical-item">
            <h3><a href="/article/${encodeURIComponent(article.slug)}">${escapeHtml(article.title)}</a></h3>
            ${renderChips(article.categories, 'Categories')}
            ${renderChips(article.tags, 'Tags')}
            ${article.coverImageUrl ? `<img class="cover-image" src="${article.coverImageUrl}" alt="${escapeHtml(article.title)}" />` : ''}
            <div class="article-content">${article.content || ''}</div>
            <p><a class="btn btn-ghost" href="/article/${encodeURIComponent(article.slug)}">Lire la page article</a></p>
          </article>
        `;
      };

      const loadLatestArticle = async () => {
        try {
          const response = await fetch('/api/articles?page=1&pageSize=1', { cache: 'no-store' });
          if (!response.ok) throw new Error('Failed to load articles');
          const payload = await response.json();
          const latest = (payload.items || [])[0] || null;
          renderLatestArticle(latest);
        } catch (error) {
          const container = document.getElementById('latestArticle');
          if (container) {
            container.innerHTML = '<p class="error">Erreur de chargement de l\'article.</p>';
          }
          console.error(error);
        }
      };

      document.getElementById('year').textContent = new Date().getFullYear();
      loadLandingContent();
      loadLatestArticle();
    </script>
  </body>
</html>
