<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Articles | ImSexpat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="admin-body">
    <header class="site-header">
      <div class="brand">IMSEXPAT ADMIN</div>
      <form method="post" action="/admin/logout">
        <button class="btn btn-ghost" type="submit">Se deconnecter</button>
      </form>
    </header>

    <main class="admin-main">
      <section class="admin-panel admin-panel-wide">
        <h1>Articles</h1>
        <p>Cree, optimise et reference les articles.</p>
        <p id="articleStatus" class="success" hidden>Article enregistre.</p>

        <form id="articleForm" class="editor-form" enctype="multipart/form-data">
          <input type="hidden" name="id" />

          <label class="field">
            <span>Titre</span>
            <input name="title" type="text" required />
          </label>

          <label class="field">
            <span>Slug (optionnel)</span>
            <input name="slug" type="text" placeholder="auto-genere depuis le titre" />
            <small class="hint">Slug final: <code id="slugPreview">-</code> <span id="slugState" class="muted"></span></small>
          </label>

          <label class="field">
            <span>Resume</span>
            <textarea name="excerpt" rows="2"></textarea>
          </label>

          <div class="field-row">
            <label class="field">
              <span>Categories (separees par des virgules)</span>
              <input name="categories" type="text" placeholder="Guide, Visa, Budget" />
            </label>
            <label class="field">
              <span>Tags (separes par des virgules)</span>
              <input name="tags" type="text" placeholder="Bangkok, assurance" />
            </label>
          </div>

          <h2>SEO</h2>
          <label class="field">
            <span>SEO title</span>
            <input name="seoTitle" type="text" placeholder="Titre SEO (sinon titre article)" />
          </label>
          <label class="field">
            <span>SEO description</span>
            <textarea name="seoDescription" rows="2" placeholder="Description SEO (sinon resume)"></textarea>
          </label>
          <label class="field">
            <span>OG image URL (optionnel)</span>
            <input name="ogImageUrl" type="text" placeholder="https://..." />
          </label>

          <div class="field">
            <span>Contenu</span>
            <div class="editor-toolbar-row">
              <button id="openMediaPickerBtn" class="btn btn-ghost" type="button">Inserer depuis Media</button>
            </div>
            <div id="contentEditor" class="rich-editor"></div>
            <input name="content" type="hidden" />
          </div>

          <div class="field-row">
            <label class="field">
              <span>Image de couverture (URL optionnelle)</span>
              <input name="coverImageUrl" type="text" placeholder="https://..." />
            </label>
            <label class="field">
              <span>Upload image de couverture (max 8MB)</span>
              <input name="coverImage" type="file" accept="image/*" />
            </label>
          </div>

          <label class="field check-field">
            <input name="published" type="checkbox" />
            <span>Publie</span>
          </label>

          <div class="editor-actions">
            <div class="editor-actions-left">
              <a href="/admin" class="btn btn-ghost">Retour admin</a>
              <a href="/admin/media" class="btn btn-ghost">Bibliotheque media</a>
              <button id="resetFormBtn" class="btn btn-ghost" type="button">Nouveau</button>
            </div>
            <button class="btn btn-primary" type="submit">Enregistrer</button>
          </div>
        </form>
      </section>

      <section class="admin-panel admin-panel-wide article-list-panel">
        <h2>Liste des articles</h2>

        <div class="filter-row">
          <input id="searchInput" type="text" placeholder="Recherche plein texte..." />
          <select id="categoryFilter"><option value="">Toutes categories</option></select>
          <select id="tagFilter"><option value="">Tous tags</option></select>
          <button id="runFilterBtn" class="btn btn-ghost" type="button">Filtrer</button>
        </div>

        <div id="articlesList" class="admin-list"></div>
        <div class="pager-row" id="pagerRow"></div>
      </section>
    </main>

    <div id="mediaPickerModal" class="modal" hidden>
      <div class="modal-backdrop" data-close-media-modal="1"></div>
      <section class="modal-card">
        <header class="modal-header">
          <h2>Bibliotheque Media</h2>
          <button id="closeMediaPickerBtn" class="btn btn-ghost" type="button">Fermer</button>
        </header>
        <div id="mediaPickerGrid" class="media-grid"></div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
      const form = document.getElementById('articleForm');
      const statusEl = document.getElementById('articleStatus');
      const listEl = document.getElementById('articlesList');
      const resetBtn = document.getElementById('resetFormBtn');
      const slugPreviewEl = document.getElementById('slugPreview');
      const slugStateEl = document.getElementById('slugState');
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const tagFilter = document.getElementById('tagFilter');
      const runFilterBtn = document.getElementById('runFilterBtn');
      const pagerRow = document.getElementById('pagerRow');
      const openMediaPickerBtn = document.getElementById('openMediaPickerBtn');
      const closeMediaPickerBtn = document.getElementById('closeMediaPickerBtn');
      const mediaPickerModal = document.getElementById('mediaPickerModal');
      const mediaPickerGrid = document.getElementById('mediaPickerGrid');

      const draftKey = 'imsexpat_admin_article_draft_v1';
      let dirty = false;
      let slugTimer = null;
      let currentPage = 1;
      let lastRange = null;

      const quill = new Quill('#contentEditor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ align: [] }],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['blockquote', 'code-block', 'link'],
            ['clean']
          ]
        }
      });

      const insertImageAtCursor = (url) => {
        if (!url) return;
        const range = lastRange || quill.getSelection() || { index: quill.getLength(), length: 0 };
        quill.insertEmbed(range.index, 'image', url, 'user');
        quill.setSelection(range.index + 1, 0);
        lastRange = { index: range.index + 1, length: 0 };
        markDirty();
        saveDraft();
      };

      const renderMediaPicker = (files) => {
        if (!Array.isArray(files) || files.length === 0) {
          mediaPickerGrid.innerHTML = '<p class="muted">Aucune image disponible.</p>';
          return;
        }

        mediaPickerGrid.innerHTML = files.map((file) => `
          <article class="media-card">
            <img src="${file.url}" alt="${escapeHtml(file.name || '')}" loading="lazy" />
            <div class="media-meta">
              <strong title="${escapeHtml(file.name || '')}">${escapeHtml(file.name || '')}</strong>
            </div>
            <div class="media-actions">
              <button class="btn btn-primary" type="button" data-insert-url="${file.url}">Inserer</button>
            </div>
          </article>
        `).join('');
      };

      const openMediaPicker = async () => {
        const current = quill.getSelection();
        if (current) lastRange = current;
        mediaPickerModal.hidden = false;
        mediaPickerGrid.innerHTML = '<p class="muted">Chargement...</p>';
        try {
          const response = await fetch('/api/admin/uploads', { cache: 'no-store' });
          if (!response.ok) throw new Error('Chargement media impossible');
          const files = await response.json();
          renderMediaPicker(files);
        } catch (error) {
          mediaPickerGrid.innerHTML = `<p class="error">${escapeHtml(error.message)}</p>`;
        }
      };

      const closeMediaPicker = () => {
        mediaPickerModal.hidden = true;
      };

      const slugify = (value) => String(value || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .slice(0, 80) || 'article';

      const escapeHtml = (value) => String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');

      const setStatus = (message) => {
        statusEl.textContent = message;
        statusEl.hidden = false;
        setTimeout(() => {
          statusEl.hidden = true;
        }, 1800);
      };

      const getPayloadPreview = () => {
        const title = form.elements.title.value;
        const rawSlug = form.elements.slug.value || title;
        const slug = slugify(rawSlug);
        const id = Number(form.elements.id.value || 0) || null;
        return { slug, id };
      };

      const checkSlug = async () => {
        const { slug, id } = getPayloadPreview();
        slugPreviewEl.textContent = slug || '-';

        if (!slug) {
          slugStateEl.textContent = '';
          return;
        }

        const params = new URLSearchParams({ slug });
        if (id) params.set('excludeId', String(id));

        const response = await fetch(`/api/admin/articles/slug-check?${params.toString()}`, { cache: 'no-store' });
        if (!response.ok) {
          slugStateEl.textContent = 'verification indisponible';
          return;
        }

        const data = await response.json();
        slugStateEl.textContent = data.available ? 'disponible' : 'deja pris';
        slugStateEl.className = data.available ? 'success' : 'error';
      };

      const scheduleSlugCheck = () => {
        clearTimeout(slugTimer);
        slugTimer = setTimeout(() => {
          checkSlug().catch(() => {
            slugStateEl.textContent = 'verification indisponible';
          });
        }, 250);
      };

      const saveDraft = () => {
        const data = {
          id: form.elements.id.value,
          title: form.elements.title.value,
          slug: form.elements.slug.value,
          excerpt: form.elements.excerpt.value,
          categories: form.elements.categories.value,
          tags: form.elements.tags.value,
          seoTitle: form.elements.seoTitle.value,
          seoDescription: form.elements.seoDescription.value,
          ogImageUrl: form.elements.ogImageUrl.value,
          coverImageUrl: form.elements.coverImageUrl.value,
          published: form.elements.published.checked,
          content: quill.root.innerHTML,
          ts: Date.now()
        };
        localStorage.setItem(draftKey, JSON.stringify(data));
      };

      const loadDraft = () => {
        const raw = localStorage.getItem(draftKey);
        if (!raw) return;
        let draft = null;
        try {
          draft = JSON.parse(raw);
        } catch (_e) {
          return;
        }
        if (!draft || !draft.title) return;

        const apply = window.confirm('Un brouillon local existe. Le charger ?');
        if (!apply) return;

        form.elements.id.value = draft.id || '';
        form.elements.title.value = draft.title || '';
        form.elements.slug.value = draft.slug || '';
        form.elements.excerpt.value = draft.excerpt || '';
        form.elements.categories.value = draft.categories || '';
        form.elements.tags.value = draft.tags || '';
        form.elements.seoTitle.value = draft.seoTitle || '';
        form.elements.seoDescription.value = draft.seoDescription || '';
        form.elements.ogImageUrl.value = draft.ogImageUrl || '';
        form.elements.coverImageUrl.value = draft.coverImageUrl || '';
        form.elements.published.checked = Boolean(draft.published);
        quill.root.innerHTML = draft.content || '<p><br></p>';
        dirty = true;
        scheduleSlugCheck();
      };

      const clearDraft = () => localStorage.removeItem(draftKey);

      const markDirty = () => {
        dirty = true;
      };

      const markClean = () => {
        dirty = false;
      };

      const resetForm = () => {
        form.reset();
        form.elements.id.value = '';
        form.elements.content.value = '';
        quill.setText('');
        markClean();
        clearDraft();
        scheduleSlugCheck();
      };

      const fillTaxonomies = (taxonomies) => {
        const categories = taxonomies.categories || [];
        const tags = taxonomies.tags || [];

        categoryFilter.innerHTML = '<option value="">Toutes categories</option>' + categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        tagFilter.innerHTML = '<option value="">Tous tags</option>' + tags.map((t) => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      };

      const renderList = (items, pagination) => {
        if (!Array.isArray(items) || items.length === 0) {
          listEl.innerHTML = '<p class="muted">Aucun article pour le moment.</p>';
          pagerRow.innerHTML = '';
          return;
        }

        listEl.innerHTML = items.map((article) => {
          const state = article.published ? 'Publie' : 'Brouillon';
          const cat = (article.categories || []).join(', ');
          const tag = (article.tags || []).join(', ');
          return `
            <article class="list-item">
              <div>
                <strong>${escapeHtml(article.title)}</strong>
                <p class="muted">/${escapeHtml(article.slug)} · ${state}</p>
                ${cat ? `<p class="muted">Categories: ${escapeHtml(cat)}</p>` : ''}
                ${tag ? `<p class="muted">Tags: ${escapeHtml(tag)}</p>` : ''}
              </div>
              <div class="list-actions">
                <button class="btn btn-ghost" type="button" data-action="edit" data-id="${article.id}">Modifier</button>
                <button class="btn btn-ghost" type="button" data-action="delete" data-id="${article.id}">Supprimer</button>
              </div>
            </article>
          `;
        }).join('');

        if (!pagination) {
          pagerRow.innerHTML = '';
          return;
        }

        const prevDisabled = pagination.page <= 1 ? 'disabled' : '';
        const nextDisabled = pagination.page >= pagination.totalPages ? 'disabled' : '';

        pagerRow.innerHTML = `
          <button class="btn btn-ghost" type="button" data-page="${pagination.page - 1}" ${prevDisabled}>Prec</button>
          <span class="muted">Page ${pagination.page}/${pagination.totalPages} (${pagination.total})</span>
          <button class="btn btn-ghost" type="button" data-page="${pagination.page + 1}" ${nextDisabled}>Suiv</button>
        `;
      };

      const loadArticles = async (page = 1) => {
        currentPage = page;
        const params = new URLSearchParams({ page: String(page), pageSize: '12' });
        if (searchInput.value.trim()) params.set('q', searchInput.value.trim());
        if (categoryFilter.value) params.set('category', categoryFilter.value);
        if (tagFilter.value) params.set('tag', tagFilter.value);

        const response = await fetch(`/api/admin/articles?${params.toString()}`, { cache: 'no-store' });
        if (!response.ok) throw new Error('Impossible de charger les articles');
        const data = await response.json();
        fillTaxonomies(data.taxonomies || { categories: [], tags: [] });
        renderList(data.items || [], data.pagination);
      };

      const loadOne = async (id) => {
        const response = await fetch(`/api/admin/articles/${id}`, { cache: 'no-store' });
        if (!response.ok) throw new Error('Article introuvable');
        const article = await response.json();

        form.elements.id.value = article.id;
        form.elements.title.value = article.title || '';
        form.elements.slug.value = article.slug || '';
        form.elements.excerpt.value = article.excerpt || '';
        form.elements.categories.value = (article.categories || []).join(', ');
        form.elements.tags.value = (article.tags || []).join(', ');
        form.elements.seoTitle.value = article.seoTitle || '';
        form.elements.seoDescription.value = article.seoDescription || '';
        form.elements.ogImageUrl.value = article.ogImageUrl || '';
        quill.root.innerHTML = article.content || '<p><br></p>';
        form.elements.coverImageUrl.value = article.coverImageUrl || '';
        form.elements.published.checked = Boolean(article.published);
        markClean();
        saveDraft();
        scheduleSlugCheck();
      };

      const deleteOne = async (id) => {
        const response = await fetch(`/api/admin/articles/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          throw new Error(payload.error || 'Suppression impossible');
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const plainText = quill.getText().trim();
        if (!plainText) {
          alert('Le contenu de l\'article est vide.');
          return;
        }

        form.elements.content.value = quill.root.innerHTML;
        const payload = new FormData(form);

        const response = await fetch('/api/admin/articles', {
          method: 'POST',
          body: payload
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => ({}));
          alert(errorPayload.error || 'Erreur lors de la sauvegarde');
          return;
        }

        const out = await response.json();
        setStatus('Article enregistre.');
        form.elements.id.value = String(out.article && out.article.id ? out.article.id : form.elements.id.value || '');
        markClean();
        clearDraft();
        await loadArticles(currentPage);
        scheduleSlugCheck();
      });

      listEl.addEventListener('click', async (event) => {
        const target = event.target;
        const action = target.getAttribute('data-action');
        const id = target.getAttribute('data-id');

        if (!action || !id) return;

        if (action === 'edit') {
          loadOne(id).catch((error) => alert(error.message));
          return;
        }

        if (action === 'delete') {
          const ok = window.confirm('Supprimer cet article ?');
          if (!ok) return;
          deleteOne(id)
            .then(async () => {
              setStatus('Article supprime.');
              if (String(form.elements.id.value) === String(id)) {
                resetForm();
              }
              await loadArticles(currentPage);
            })
            .catch((error) => alert(error.message));
        }
      });

      pagerRow.addEventListener('click', (event) => {
        const page = Number(event.target.getAttribute('data-page') || 0);
        if (!page || page < 1) return;
        loadArticles(page).catch((error) => alert(error.message));
      });

      runFilterBtn.addEventListener('click', () => {
        loadArticles(1).catch((error) => alert(error.message));
      });

      [form.elements.title, form.elements.slug].forEach((el) => {
        el.addEventListener('input', () => {
          markDirty();
          saveDraft();
          scheduleSlugCheck();
        });
      });

      ['excerpt', 'categories', 'tags', 'seoTitle', 'seoDescription', 'ogImageUrl', 'coverImageUrl'].forEach((name) => {
        form.elements[name].addEventListener('input', () => {
          markDirty();
          saveDraft();
        });
      });

      form.elements.published.addEventListener('change', () => {
        markDirty();
        saveDraft();
      });

      quill.on('text-change', () => {
        markDirty();
        saveDraft();
      });

      quill.on('selection-change', (range) => {
        if (range) {
          lastRange = range;
        }
      });

      resetBtn.addEventListener('click', () => resetForm());

      window.addEventListener('beforeunload', (event) => {
        if (!dirty) return;
        event.preventDefault();
        event.returnValue = '';
      });

      const params = new URLSearchParams(window.location.search);
      const pendingImage = params.get('insertImage');
      if (pendingImage) {
        insertImageAtCursor(pendingImage);
        params.delete('insertImage');
        const next = params.toString();
        window.history.replaceState({}, '', `${window.location.pathname}${next ? `?${next}` : ''}`);
      }

      openMediaPickerBtn.addEventListener('click', () => {
        openMediaPicker().catch((error) => alert(error.message));
      });

      closeMediaPickerBtn.addEventListener('click', closeMediaPicker);
      mediaPickerModal.addEventListener('click', (event) => {
        if (event.target.getAttribute('data-close-media-modal') === '1') {
          closeMediaPicker();
        }
      });

      mediaPickerGrid.addEventListener('click', (event) => {
        const url = event.target.getAttribute('data-insert-url');
        if (!url) return;
        insertImageAtCursor(url);
        closeMediaPicker();
      });

      loadDraft();
      scheduleSlugCheck();
      loadArticles(1).catch((error) => alert(error.message));
    </script>
  </body>
</html>
