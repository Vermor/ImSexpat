<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Articles | ImSexpat</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="brand">ImSexpat</div>
      <a class="admin-link" href="/admin/login">Admin</a>
    </header>

    <main>
      <section class="admin-panel admin-panel-wide">
        <h1>Articles</h1>
        <div class="filter-row">
          <input id="q" type="text" placeholder="Recherche..." />
          <select id="category"><option value="">Toutes categories</option></select>
          <select id="tag"><option value="">Tous tags</option></select>
          <button id="apply" class="btn btn-ghost" type="button">Filtrer</button>
        </div>
        <div id="publicArticles" class="admin-list"></div>
        <div class="pager-row" id="pagerRow"></div>
      </section>
    </main>

    <script>
      const listEl = document.getElementById('publicArticles');
      const pagerEl = document.getElementById('pagerRow');
      const qEl = document.getElementById('q');
      const categoryEl = document.getElementById('category');
      const tagEl = document.getElementById('tag');
      const applyEl = document.getElementById('apply');
      const initialSearch = new URLSearchParams(window.location.search);
      const state = {
        page: Math.max(1, Number(initialSearch.get('page') || 1)),
        q: initialSearch.get('q') || '',
        category: initialSearch.get('category') || '',
        tag: initialSearch.get('tag') || ''
      };

      const escapeHtml = (value) => String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');

      const fillTaxonomies = (tax) => {
        const categories = tax.categories || [];
        const tags = tax.tags || [];
        categoryEl.innerHTML = '<option value="">Toutes categories</option>' + categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        tagEl.innerHTML = '<option value="">Tous tags</option>' + tags.map((t) => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
        if (state.category && !categories.includes(state.category)) {
          categoryEl.innerHTML += `<option value="${escapeHtml(state.category)}">${escapeHtml(state.category)}</option>`;
        }
        if (state.tag && !tags.includes(state.tag)) {
          tagEl.innerHTML += `<option value="${escapeHtml(state.tag)}">${escapeHtml(state.tag)}</option>`;
        }
        if (state.category) categoryEl.value = state.category;
        if (state.tag) tagEl.value = state.tag;
      };

      const render = (articles, pagination) => {
        if (!articles.length) {
          listEl.innerHTML = '<p class="muted">Aucun article publie.</p>';
          pagerEl.innerHTML = '';
          return;
        }

        listEl.innerHTML = articles.map((article) => `
          <article class="list-item vertical-item">
            <div>
              <h2><a href="/article/${encodeURIComponent(article.slug)}">${escapeHtml(article.title)}</a></h2>
              <p class="muted">${escapeHtml(article.excerpt || '')}</p>
            </div>
          </article>
        `).join('');

        const prevDisabled = pagination.page <= 1 ? 'disabled' : '';
        const nextDisabled = pagination.page >= pagination.totalPages ? 'disabled' : '';
        pagerEl.innerHTML = `
          <button class="btn btn-ghost" type="button" data-page="${pagination.page - 1}" ${prevDisabled}>Prec</button>
          <span class="muted">Page ${pagination.page}/${pagination.totalPages}</span>
          <button class="btn btn-ghost" type="button" data-page="${pagination.page + 1}" ${nextDisabled}>Suiv</button>
        `;
      };

      const load = async (page = 1) => {
        const params = new URLSearchParams({ page: String(page), pageSize: '9' });
        if (state.q) params.set('q', state.q);
        if (state.category) params.set('category', state.category);
        if (state.tag) params.set('tag', state.tag);

        const res = await fetch(`/api/articles?${params.toString()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('Erreur de chargement des articles.');
        const data = await res.json();
        fillTaxonomies(data.taxonomies || { categories: [], tags: [] });
        render(data.items || [], data.pagination || { page: 1, totalPages: 1 });
        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set('page', String(page));
        if (state.q) nextUrl.searchParams.set('q', state.q); else nextUrl.searchParams.delete('q');
        if (state.category) nextUrl.searchParams.set('category', state.category); else nextUrl.searchParams.delete('category');
        if (state.tag) nextUrl.searchParams.set('tag', state.tag); else nextUrl.searchParams.delete('tag');
        window.history.replaceState(null, '', `${nextUrl.pathname}?${nextUrl.searchParams.toString()}`);
      };

      qEl.value = state.q;

      applyEl.addEventListener('click', () => {
        state.q = qEl.value.trim();
        state.category = categoryEl.value;
        state.tag = tagEl.value;
        state.page = 1;
        load(state.page).catch((error) => {
          listEl.innerHTML = `<p class="error">${error.message}</p>`;
        });
      });

      pagerEl.addEventListener('click', (event) => {
        const page = Number(event.target.getAttribute('data-page') || 0);
        if (!page || page < 1) return;
        state.page = page;
        load(state.page).catch((error) => {
          listEl.innerHTML = `<p class="error">${error.message}</p>`;
        });
      });

      load(state.page).catch((error) => {
        listEl.innerHTML = `<p class="error">${error.message}</p>`;
      });
    </script>
  </body>
</html>
